<!doctype html>  
<html>
	<head>
		<meta charset="utf-8">
		<title class="l_labname">Lab: App Interconnections</title>
		<meta name="description" content="Titanium Certified Expert, App Interconnections">
    	<meta name="author" content="Appcelerator, Inc." />
		
		<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="../presentation-engine/reveal.js/css/reset.css">
		<link rel="stylesheet" href="../presentation-engine/reveal.js/css/main.css">
		<link rel="stylesheet" href="../presentation-engine/reveal.js/lib/zenburn.css">
		<link rel="stylesheet" href="../css/presentation.css">
		<script type="text/javascript" src="../presentation-engine/js/l10n.js"></script>
		<script type="text/javascript" src="i18n/lablocalizations.js"></script>
		<style>
		html, body {
			overflow: always !important;
		}
		.slides {
			top: 40% !important;
		}
		pre {
			font-size: 80% !important;
		}
		</style>
		<script>
		function loadStyleSheet(url){
		    if(document.createStyleSheet) {
		        try {document.createStyleSheet(url);} catch (e) { }
		    }
		    else{
		        var css;
		        css         = document.createElement('link');
		        css.rel     = 'stylesheet';
		        css.type    = 'text/css';
		        css.media   = "all";
		        css.href    = url;
		        document.getElementsByTagName("head")[0].appendChild(css);
		    }
		}
		var browserlang = document.documentElement.lang || String.locale || 'en-US';
		loadStyleSheet('../css/'+browserlang+'.css');
		</script>
		<link rel="stylesheet" href="../presentation-engine/reveal.js/css/print.css" media="print">
	</head>
	
	<body>
		<div id="reveal">	
			<!-- Any section element inside of this container is displayed as a slide -->

			<!--
				LAB FILE INSTRUCTIONS:
					- Set the <title> tag to this lesson's US English title
					- Set the <meta description tag to the US English course & lesson title
					- Add one <section></section> for each slide. Slides can contain most any valid HTML
					- Each text tag (<p> or <li> or <h1> etc.) must have a class name that begins with
						"l_" and is unique. Each of those class names must be added to the i18n/localizations.js
						file and their values must be set equal to the US English version of the strings. That 
						file is used for translation and its contents OVERRIDES the text in this file.
					- Each slide must have a <div class="slidenote"></div> container, which can be empty. These
						are used for presenter notes. They also must be given unique "l_" classnames and strings
						provided in the localizations.js file.
					- Please use inline CSS on the slides to size & arrange contents.
					- Graphics should be placed in the images folder and cropped/sized appropriately.
					- Assume a 1024 x 768 display resolution
					- A link to the index.html for each lesson must be added in order to the coursename/index.html
						title slide.
			-->
			
			
<div class="slides">
<div id="labwrapper">			
<section>

<!-- YOUR LAB CONTENT GOES HERE -->
<h1 class="l_labname">Lab - App Interconnections</h1>
<p class="l_mission"><strong>Mission: </strong>In this lab, you will write two interconnected apps: one app will be able to launch and pass data to the other app.</p>

<p class="l_specification"><strong>Specification: </strong><img src='http://assets.appcelerator.com.s3.amazonaws.com/app_u/tce_labs/Finished/08applaunch.png' height='300' align='right' style="border: 1px solid #000;"/>You will write two apps, a "source" and "target" app. <br/><br/>
The Target app will include five buttons, which when clicked will open various built-in or standard apps, such as Maps or SMS. You can extend the app you started in the "Try It" exercise in this lesson.<br/><br/>
The Source app will include three buttons, which will launch the target app and optionally send it launch parameters to control the target app's actions.</p>

<table>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<tr>
	<td colspan="2" class="labinstructions l_labstep1">1. If you created the "Try It" application in this lesson, you can use it as your Target app. If not, create a new Alloy project named URLSchemes with an app ID of com.<em>yourname</em>.urlschemes. In its index view, add five buttons labeled as follows: Open Maps, Open SMS, Open Dialer, Open YouTube, and Open App Store / Market. To simplify layout, set the Window to 'vertical' layout and set a top of 20 or so for each button.</td>
</tr>
<tr>
	<td class="tdfiller"><!-- leave empty--></td>
	<td class="labexplanations l_labstepexplanation1"></td>
</tr>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<tr>
	<td colspan="2" class="labinstructions l_labstep2">2. Add a click event listener to each of the buttons. Then, in the index controller, use the <code>Ti.Platform.openURL()</code> function and the appropriate URL schemes to open the following apps: <br/>
<ul style="margin-left:20px;">
	<li>Maps: use maps:// or http:// as the URL scheme for iOS &amp; Android respectively. Use this as the map location: <br/>
<pre><code>maps.google.com/maps?q=440+Bernardo+Ave,+Mountain+View,+CA&hl=en&sll=42.746632,-75.770041&sspn=6.364676,10.305176&oq=44&hnear=440+Bernardo+Ave,+Mountain+View,+Santa+Clara,+California+94043&t=m&z=17</code/></pre>
		</li>
	<li>SMS: use sms:+ and a number of your choice</li>
	<li>Phone: use tel:// and a number of your choice</li>
	<li>YouTube: use http://www.youtube.com/watch?v=iodEa0eitag as the target URL</li>
	<li>Store: for iOS, use http://itunes.apple.com/us/app/legoland-california-official/id452395530?mt=8 and for Android use market://details?id=com.zc.android<br/>Alternatively, use a target app of your choice. You can use the <a href="http://itunes.apple.com/linkmaker/">iTunes Link Maker</a> site to generate a suitable iOS App Store link; find an app's ID on <a href="https://play.google.com/store/apps">Google Play</a>. </li>
</ul></p>
</td>
</tr>
<tr>
	<td class="tdfiller"><!-- leave empty--></td>
	<td class="labexplanations l_labstepexplanation2"></td>
</tr>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<tr>
	<td colspan="2" class="labinstructions l_labstep3">3. Build and test the app by clicking each of the buttons. The native app should be opened (if installed), though the SMS, dialer, and market buttons won't work on the simulator/emulator.</td>
</tr>
<tr>
	<td class="tdfiller"><!-- leave empty--></td>
	<td class="labexplanations l_labstepexplanation3"></td>
</tr>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<tr>
	<td colspan="2" class="labinstructions l_labstep4">4. Next, we'll modify the app so that it's configured to be launched by your second app. There are separate steps for iOS and Android.<br/><br/>For iOS: to the tiapp.xml file, add the following code, making sure that the app ID matches your app's actual app ID:<br/>
<pre><code>
&lt;ios>
  &lt;key>CFBundleURLTypes&lt;/key>
  &lt;array>
    &lt;dict>
      &lt;key>CFBundleURLName&lt;/key>
      &lt;string>com.appcelerator.urlschemes&lt;/string>
      &lt;key>CFBundleURLSchemes&lt;/key>
      &lt;array>
        &lt;string>Urlschemes&lt;/string>
      &lt;/array>
    &lt;/dict>
  &lt;/array>
&lt;/ios>
</code></pre><br/>
For Android: you must have built for the emulator at least once, the follow these steps:<br/>
<ol style="margin-left:20px;list-style-type:lower-alpha;">
	<li>Open build/android/AndroidManifest.xml</li>
	<li>Copy the &lt;application> tag and all its contents</li>
	<li>In tiapp.xml, modify the &lt;android> tag to remove the '/' that makes it an empty tag; add a closing &lt;/android> tag</li>
	<li>Within that tag, add &lt;manifest>&lt;/manifest> tags</li>
	<li>Within the manifest tags, paste the tags you copied from the generated manifest</li>
	<li>Following the &lt;/intent-filter> closing tag, add the following code:<br/>
<pre><code>
&lt;intent-filter>
  &lt;action android:name="android.intent.action.VIEW"/>
  &lt;category android:name="android.intent.category.DEFAULT"/>
  &lt;category android:name="android.intent.category.BROWSABLE"/>
  &lt;data android:scheme="urlschemes" android:host=""/>
&lt;/intent-filter>
</code></pre>
</li>
</ol>
</td>
</tr>
<tr>
	<td class="tdfiller"><!-- leave empty--></td>
	<td class="labexplanations l_labstepexplanation4"></td>
</tr>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<tr>
	<td colspan="2" class="labinstructions l_labstep5">5. To work around a tooling default, we'll need to build the project from the command line with an additional flag. First, clean the project in Studio. Then, open a terminal window and navigate to your project's root directory. Enter the following command (make sure to specify the appropriate target platform, though):<br/>
<pre><code>
titanium build --platform ios --force-copy
</code></pre>
<br/>By adding --force-copy, we tell the tooling to copy the source files to the built project rather than creating symbolic links to those files. Without this flag, the app will likely crash with a strange error when you open it from your other app.
</td>
</tr>
<tr>
	<td class="tdfiller"><!-- leave empty--></td>
	<td class="labexplanations l_labstepexplanation5"></td>
</tr>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<tr>
	<td colspan="2" class="labinstructions l_labstep6">6. Create a second Alloy app with a name and app ID of your choice. This app should have three buttons, each with a custom property named 'action' as follows: <br/>
		<table width="600" border="1" cellspacing="0" cellpadding="2">
			<tr>
				<td width="150"><strong>Label</strong></td>
				<td width="250"><strong>'action' property</strong></td>
			</tr>
			<tr>
				<td>Open Target app</td>
				<td></td>
			</tr>
			<tr>
				<td>In Target app, open Maps</td>
				<td>maps</td>
			</tr>
			<tr>
				<td>In Target app, open YouTube</td>
				<td>youtube</td>
			</tr>
		</table>
</td>
</tr>
<tr>
	<td class="tdfiller"><!-- leave empty--></td>
	<td class="labexplanations l_labstepexplanation6"></td>
</tr>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<tr>
	<td colspan="2" class="labinstructions l_labstep7">7. In the root controller, write the doClick() function as follows:<br/>
<pre><code>
function doClick(e) {  
  if(OS_IOS) {
    if(Ti.Platform.canOpenURL('Urlschemes://')) {
      Ti.Platform.openURL('Urlschemes://?'+action);
    } else {
      alert('You must install the Target app first');
    }
  } else {
    var didItWork = Ti.Platform.openURL('urlschemes://?'+action);
    if(!didItWork) {
      alert('You need to install the Target app');
    }
  }
}

$.index.open();
</code></pre>
</td>
</tr>
<tr>
	<td class="tdfiller"><!-- leave empty--></td>
	<td class="labexplanations l_labstepexplanation7"></td>
</tr>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<tr>
	<td colspan="2" class="labinstructions l_labstep8">8. Build your app from the command line using the techniques described in step 5 above. Once the app is running, tap the Open Target App button. Your first app (the URLSchemes app) should open. Close the simulator. Now we need to enable the target app (URLSchemes) to accept and process the arguments.</td>
</tr>
<tr>
	<td class="tdfiller"><!-- leave empty--></td>
	<td class="labexplanations l_labstepexplanation8"></td>
</tr>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<tr>
	<td colspan="2" class="labinstructions l_labstep9">9. In your URLSchemes app, open the alloy.js file. We'll need to add code here to support Android, and we'll define a global function used on both platforms. Add the following code:<br/>
<pre><code>
Alloy.Globals.urlParser = function(url) {
    url = url.replace(/[Uu]rlschemes:\/\/\?/,"");
    return url.split('&');
};


if(OS_ANDROID) {
    Alloy.Globals.action = '';    
    var activity = Ti.Android.currentActivity;
    function doIt(e) {
        var args = activity.getIntent().getData();
        if(args && args != 'urlschemes://') {
            // parse the url string and arguments
            var parsedArgs = Alloy.Globals.urlParser(args);
            switch(parsedArgs[0]) {
                case 'maps':
                    Alloy.Globals.action = 'maps';
                break;
                case 'youtube':
                    Alloy.Globals.action = 'youtube';
                break;
            }
        }
    }           
    activity.addEventListener("start", doIt);
}
</code></pre>
</td>
</tr>
<tr>
	<td class="tdfiller"><!-- leave empty--></td>
	<td class="labexplanations l_labstepexplanation9"></td>
</tr>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<tr>
	<td colspan="2" class="labinstructions l_labstep10">10. Next, open the index controller. Add the following code before the open() call.<br/>
<pre><code>
// check for arguments passed to this app
if(OS_IOS) {
    $.index.addEventListener('open', function(e){
        	function grabArguments() {
        		var args = Ti.App.getArguments();
        		if(args.url) {
        			// property present only if app has been launched from the other app
        			var parsedArgs = Alloy.Globals.urlParser(args.url);
        			switch(parsedArgs[0]) {
        				case 'maps':
        					doClickMaps();
        				break;
        				case 'youtube':
        					doClickYouTube();
        				break;
        			}
        		}
        	}
        	grabArguments();
        	Ti.App.addEventListener('resumed', grabArguments);
    });
} else if(OS_ANDROID) {
    $.index.addEventListener('open', function() {
        switch(Alloy.Globals.action) {
            case 'maps':
                doClickMaps();
            break;
            case 'youtube':
                doClickYouTube();
            break;
        }
    });
}
</code></pre>
</td>
</tr>
<tr>
	<td class="tdfiller"><!-- leave empty--></td>
	<td class="labexplanations l_labstepexplanation10"></td>
</tr>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<tr>
	<td colspan="2" class="labinstructions l_labstep11">11. Build both apps using the command-line technique described above. In the "source" app, click either the <em>In Target app, open Maps</em> or <em>In Target app, open YouTube</em> buttons. The URLSchemes app should open, then immediately the appropriate target app will be opened. Correct any code errors, if necessary.</td>
</tr>
<tr>
	<td class="tdfiller"><!-- leave empty--></td>
	<td class="labexplanations l_labstepexplanation11"></td>
</tr>
</table>

<h2 class="l_summary">Summary</h2>
<p class="l_summarypara">In this lab, you created two apps. One opened "stock" apps via their standard URL schemes. The other opened the first app, optionally passing parameters to it to control its operations. </p>

<h2 class="l_resources">Resources</h2>

<ul>
	<li class="l_resources1">API docs: Ti.Platform: <a href='http://docs.appcelerator.com/titanium/latest/#!/api/Titanium.Platform'>http://docs.appcelerator.com/titanium/latest/#!/api/Titanium.Platform</a></li>
	<li class="l_resources2">BenCoding.com Blog: Opening Custom Url Schemas with Titanium: <a href='http://bencoding.com/2012/11/11/opening-custom-url-schemas-with-titanium/'>http://bencoding.com/2012/11/11/opening-custom-url-schemas-with-titanium/</a></li>
	<li class="l_resources3">Finished code: <a href='http://assets.appcelerator.com.s3.amazonaws.com/app_u/tce_labs/Finished/08_source.zip'>Amazon S3: source app</a> <a href='http://assets.appcelerator.com.s3.amazonaws.com/app_u/tce_labs/Finished/URLSchemes.zip'>Amazon S3: URLSchemes (target) app</a></li>
</ul>


<!-- MAKE NO CHANGES BELOW THIS LINE -->
</section>
</div>
</div>

			<!-- Appc logo and presenter notes -->
			<div id="appclogo"><a href="../index.html"><img src="../images/appu_thumb.png"/></a></div>

			<!-- The navigational controls UI -->
			<aside class="controls">
				<a class="left" href="#">&#x25C4;</a>
				<a class="right" href="#">&#x25BA;</a>
				<a class="up" href="#">&#x25B2;</a>
				<a class="down" href="#">&#x25BC;</a>
			</aside>

			<!-- Displays presentation progress, max value changes via JS to reflect # of slides -->
			<div class="progress"><span></span></div>
			
		</div>
		
		<script src="../presentation-engine/reveal.js/js/reveal.js"></script>
		<script src="../presentation-engine/reveal.js/lib/highlight.js"></script>
		<script>
			// Parse the query string into a key/value object
			var query = {};
			location.search.replace( /[A-Z0-9]+?=(\w*)/gi, function(a) {
				query[ a.split( '=' ).shift() ] = a.split( '=' ).pop();
			} );

			Reveal.initialize({
				// Display controls in the bottom right corner
				controls: true,

				// Display a presentation progress bar
				progress: true,

				// If true; each slide will be pushed to the browser history
				history: true,

				// Flags if mouse wheel navigation should be enabled
				mouseWheel: true,

				// Apply a 3D roll to links on hover
				rollingLinks: true,

				// UI style
				theme: query.theme || 'default', // default/neon

				// Transition style
				transition: query.transition || 'default' // default/cube/page/concave/linear(2d)
			});

			hljs.initHighlightingOnLoad();
		</script>
		<script src="../presentation-engine/js/localize.js"></script>
		<script>
		var s = (function load(){
			var s = {};
			if(window.outerHeight){
				s = { w: window.outerWidth, h: window.outerHeight};
			}
			else {
				s = { w: document.body.clientWidth, h: document.body.clientHeight};
			}
			return s;
		})();
		if(s.w < 1000 || s.h < 800) {
			var slides = document.querySelectorAll( '#reveal .slides' );
			for( var i = 0, len = slides.length; i < len; i++ ) {
				slides[i].classList.add( 'smallscreen' );
		    }
		}
		</script>
	</body>
</html>
